parameters:
  additionalBuildArguments: ''

steps:
- checkout: self
  fetchDepth: 1
  submodules: true
  clean: true

- task: PowerShell@2
  displayName: Verifying Nuget packages for PowerToys.sln
  inputs:
    filePath: '$(System.DefaultWorkingDirectory)\.pipelines\verifyNugetPackages.ps1'
    arguments: -solution '$(build.sourcesdirectory)\PowerToys.sln'
    pwsh: true

# this is needed for release, not CI, focusing on CI right now.
# - task: UseDotNet@2
#   displayName: 'Use .NET Core 2.1 SDK'
#   inputs:
#     packageType: sdk
#     version: '2.1.x'

- task: UseDotNet@2
  displayName: 'Use .NET 7 SDK'
  inputs:
    packageType: sdk
    version: '7.x'

- task: NuGetAuthenticate@1
      
- task: NuGetToolInstaller@1
  displayName: Use NuGet Installer latest

# this will restore the following nugets:
# - main solution
# - Bug report tool
# - Webcam report tool
# - Installer
# - Bootstrapper Installer
- task: NuGetCommand@2
  displayName: Restore NuGet packages
  inputs:
    command: restore
    restoreSolution: '**/*.sln'
    feedsToUse: config
    configPath: NuGet.config

# building solutions
- template: ${{variables['System.DefaultWorkingDirectory']}}\.pipelines\steps\build-solution.yml
  parameters:
    additionalBuildArguments: ${{ parameters.additionalBuildArguments }}
    solutionFile: '$(build.sourcesdirectory)\PowerToys.sln'

- template: ${{variables['System.DefaultWorkingDirectory']}}\.pipelines\steps\build-solution.yml
  parameters:
    additionalBuildArguments: ${{ parameters.additionalBuildArguments }}
    solutionFile: '$(build.sourcesdirectory)\tools\BugReportTool\BugReportTool.sln'

- template: ${{variables['System.DefaultWorkingDirectory']}}\.pipelines\steps\build-solution.yml
  parameters:
    additionalBuildArguments: ${{ parameters.additionalBuildArguments }}
    solutionFile: '$(build.sourcesdirectory)\tools\WebcamReportTool\WebcamReportTool.sln'

- template: ${{variables['System.DefaultWorkingDirectory']}}\.pipelines\steps\build-solution.yml
  parameters:
    additionalBuildArguments: ${{ parameters.additionalBuildArguments }}
    solutionFile: '$(build.sourcesdirectory)\tools\StylesReportTool\StylesReportTool.sln'

- task: PowerShell@2
  displayName: Download and install WiX 3.14 development build
  inputs:
    targetType: filePath
    filePath: '$(build.sourcesdirectory)\.pipelines\installWiX.ps1'

- task: VSBuild@1
  displayName: 'Build PowerToys MSI'
  inputs:
    solution: '**\installer\PowerToysSetup.sln'
    vsVersion: 17.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    msbuildArgs: /t:PowerToysInstaller ${{ parameters.additionalBuildArguments }}
    maximumCpuCount: true

- task: VSBuild@1
  displayName: 'Build PowerToys Bootstrapper'
  inputs:
    solution: '**\installer\PowerToysSetup.sln'
    vsVersion: 17.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    msbuildArgs: /t:PowerToysBootstrapper ${{ parameters.additionalBuildArguments }}
    clean: false
    maximumCpuCount: true

- template: ${{variables['System.DefaultWorkingDirectory']}}\.pipelines\steps\run-tests.yml
  parameters:
    additionalBuildArguments: ${{ parameters.additionalBuildArguments }}
